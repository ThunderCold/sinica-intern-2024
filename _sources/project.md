# Generate dataset specification in YAML format

## Use the Frictionless package

依照使用者上傳的資料集檔案（data.csv），使用 Frictionless 套件中的 Schema.describe() 功能生成資料集規範（schema.yaml）。

Based on the dataset file (`data.csv`) uploaded by the user, use `Schema.describe()` function in the Frictionless package to generate the dataset specification (`schema.yaml`).

同時，根據使用者上傳的資料欄位說明檔案（description.csv），將title與description屬性填入資料集規範中。

At the same time, based on the data field description file (`description.csv`) uploaded by the user, the `title` and `description` properties are filled in the dataset specification.

```{note}
資料集檔案（data.csv）格式限制：<br>
第一列為各欄位之 name，其餘每一列皆為一筆資料。

**Dataset file format restrictions:**<br>
The first row is the `name` of each field, and each of the remaining rows is a set of data.
```

```{note}
資料欄位說明檔案（description.csv）格式限制：<br>
第一列為各欄位之 name，第二列為各欄位之 title，第三列為各欄位之 description，第四列為各欄位之 type。並且每個資料欄位需與資料集檔案完全相同。

**Data field description file format restrictions:**<br>
The first row is the `name` of each field, the second row is the `title` of each field, the third row is the `description` of each field, and the fourth row is the `type` of each field. Each data field must be exactly the same as the dataset file.
```

```python
from frictionless import Schema

data_filename = 'data.csv'
yaml_filename = f'{data_filename}.schema.yaml' # The dataset specification is named 'dataset name + .schema.yaml'
schema = Schema.describe(data_filename)
schema.to_yaml(yaml_filename)
```

```python
with open(description_filename, newline='') as csvfile:
    with open(yaml_filename, 'r', encoding='utf-8') as file:
        csv_reader = csv.reader(csvfile)
        listReport = list(csv_reader)
        yaml_data = yaml.safe_load(file)
        for i in range(len(yaml_data['fields'])):
            yaml_data['fields'][i]['title'] = listReport[1][i]
            yaml_data['fields'][i]['description'] = listReport[2][i]
    with open(yaml_filename, 'w', encoding='utf-8') as file:
        yaml.safe_dump(yaml_data, file)
```

## Fill in the `constraints` property using Google Gemini model

但因由 Schema.describe() 功能生成的資料集規範僅包含 name 與 type 兩個property，無法有效進行資料集驗證功能。因此，依照使用者上傳的資料欄位說明檔案（description.csv），使用大型語言模型判斷各欄位之constraints property內容。

However, because the dataset specification generated by the `Schema.describe()` only contains two properties, `name` and `type`, the validate function cannot be effectively performed. Therefore, according to the data field description file uploaded by the user, a large language model is used to determine the `constraints` property of each field.

這裡使用的大型語言模型為 Google Gemini 中的 gemini-1.5-flash，使用者可先申請免費 API，並將 API Key 填入應用程式欄位中。在選定資料集檔案與資料欄位說明檔案後，程式會自動連接 Gemini 模型。因屬性欄位限制與避免精準度落差過大，目前僅使用模型生成每個資料欄位的理論最小值與最大值，若輸出結果有最小值或最大值，就會將該值填入資料集規範（schema.yaml）中；否則，若模型輸出為 Null（意即無法判斷最小值或最大值），則會跳過填入該欄位。

The large language model used here is `gemini-1.5-flash` in Google Gemini. Users can apply for a free API first and fill in the API Key in the `Gemini API Key` field. After processing the dataset file and data field description file, the program will automatically connect to the Gemini model. Due to property field restrictions and to avoid excessive accuracy gaps, currently only use the model to generate the reasonable minimum and maximum values ​​of each data field. If the output result has a minimum or maximum value, the value will be filled in the dataset specification (`schema.yaml`); otherwise, if the model output is `Null` (meaning that the reasonable minimum or maximum value cannot be determined), filling in this field will be skipped.

免費版gemini-1.5-flash模型API的使用限制為：15 requests per minute，1500 requests per day。為避免瞬間使用過多資源導致出現ResourceExhausted錯誤，偵測每個欄位進行生成會有一段間隔時間（目前設定為7秒）。

The usage limit of the free version `gemini-1.5-flash` model API is: 15 requests per minute, 1500 requests per day. In order to avoid `ResourceExhausted` errors caused by using too many resources in an instant, there will be an interval between detecting and generating each field (currently set to 7 seconds).

如果不想要使用Google Gemini model對`constraints` property進行生成，取消勾選Use Gemini AI方框即可，程式僅會根據資料集檔案與資料欄位說明檔案產生dataset specification。

If you do not want to use the Google Gemini model to generate the `constraints` property, just uncheck the `Use Gemini AI` checkbox. The program will only generate the dataset specification based on the dataset file and data field specification file.

- Text to query the Google Gemini model:
```
name: <name>\ntitle: <title>\ndescription: <description>\ntype: <type>\n\nThe above is the description of a data field. What is the maximum reasonable real-world value ​​for this data field? Please output this value ​​directly without any additional explanation. If the maximum reasonable real-world value ​​cannot be determined, "Null" is output.
```
```
name: <name>\ntitle: <title>\ndescription: <description>\ntype: <type>\n\nThe above is the description of a data field. What is the minimum reasonable real-world value ​​for this data field? Please output this value ​​directly without any additional explanation. If the minimum reasonable real-world value ​​cannot be determined, "Null" is output.
```

```python
import google.generativeai as genai

def askGemini():
    
    genai.configure(api_key = api_key)
    model = genai.GenerativeModel('gemini-1.5-flash')

    max_question = f'name: {name}\ntitle: {title}\ndescription: {description}\ntype: {type}\n\nThe above is the description of a data field. What is the maximum reasonable real-world value ​​for this data field? Please output this value ​​directly without any additional explanation. If the maximum reasonable real-world value ​​cannot be determined, "Null" is output.'
    max_response = model.generate_content(
        contents=max_question,
        safety_settings=safety_settings
    )
    min_question = f'name: {name}\ntitle: {title}\ndescription: {description}\ntype: {type}\n\nThe above is the description of a data field. What is the minimum reasonable real-world value ​​for this data field? Please output this value ​​directly without any additional explanation. If the minimum reasonable real-world value ​​cannot be determined, "Null" is output.'
    min_response = model.generate_content(
        contents=min_question,
        safety_settings=safety_settings
    )

    return max_response.text.strip(), min_response.text.strip()
```

在使用 Gemini 模型填入 constraints property 時，應用程式介面中的 System Messege 欄位會顯示系統資訊，預期中有可能會看到以下資訊：
- `Create <yaml_filename> sucessfully`：成功使用 Schema.describe() 功能生成資料集規範（schema.yaml）。
- `Detecting <name> field...`：正在使用模型生成 `<name>` 欄位之理論最小值與最大值。
- `<name> field:\nminimum:<min>, maximum:<max>`：已經完成 `<name>` 欄位之檢測，模型生成之理論最小值為 `<min>`，理論最大值為 `<max>`。
- `ResourceExhausted error occurred, will automatically retry`：超過API資源使用限制，在額外等候一段間隔時間後將自動重試。
- `Multiple ResourceExhausted errors occurred, terminating AI detection`：多次嘗試後仍超過API資源使用限制，將自動中斷模型生成。
- `InvalidArgument error occurred, please check API key`：API Key 可能有錯誤。
- `Unexpected error occurred`：Gemini 模型生成過程出現非預期錯誤。
- `AI detection completed`：已經完成該資料集規範（schema.yaml）之Gemini 模型生成。

When using the Google Gemini model to fill in the `constraints` property, the `System Message` field in the application interface will display system information. You may expect to see the following information:
- `Create <yaml_filename> sucessfully`: Successfully used the `Schema.describe()` function to generate the dataset specification.
- `Detecting <name> field...`: The model is being used to generate the reasonable minimum and maximum values ​​of the `<name>` field.
- `<name> field:\nminimum:<min>, maximum:<max>`: The detection of the `<name>` field has been completed. The reasonable minimum value generated by the model is `<min>`, and the reasonable maximum value is `<max>`.
- `ResourceExhausted error occurred, will automatically retry`: The API resource usage limit has been exceeded, and it will automatically retry after an additional waiting period.
- `Multiple ResourceExhausted errors occurred, terminating AI detection`: If the API resource usage limit is still exceeded after multiple attempts, model generation will be automatically interrupted.
- `InvalidArgument error occurred, please check API key`: The API Key provided by the user may be incorrect.
- `Unexpected error occurred`: An unexpected error occurred during the Google Gemini model generation process.
- `AI detection completed`: The Gemini model generation of the dataset specification has been completed.